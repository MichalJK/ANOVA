---
title-block-banner: '#54698a' 
title-block-banner-color : '#dee1e3'
title: "Dwuczynnikowa Anova - przykad"
author: "Micha Koodziejczyk"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
 #   number-sections: true
    tbl-pos: 'H'
css: styles.css
editor: visual
---

# Problem do rozwizania

Wykonano po 5 pomiar贸w rednic drobnego elementu produkowanego na 5 r贸偶nych maszynach przy zastosowaniu dwu r贸偶nych chodziw A i B. Nale偶y sprawdzi, czy rodzaj chodziwa ma jakikolwiek wpyw na rednic wytwarzanych element贸w.

Czynnikami wyr贸偶niajcymi s numer maszyny i rodzaj chodziwa. Do analizy problemu wykorzystano dwuczynnikow analiz wariancji, kt贸ra bada wpyw dw贸ch r贸偶nych jakociowych zmiennych niezale偶nych (jeden - maszyna, drugi - chodziwo) na jedn cig zmienn zale偶n (rednica elementu). Przykad i dane liczbowe zostay wzite z poradnika: <https://www.itl.nist.gov/div898/handbook/ppc/section2/ppc232.htm>.

Dane liczbowe zostay przedstawione w tabeli na rysunku poni偶ej.

![Pomiary rednicy $d$ elementu w zale偶noci od maszyny i chodziwa.](2czynniki.png){fig-align="center" width="447"}

Ukad zerowych hipotez, kt贸re bd testowane metod Anova:

-   $H0_1$: *Czynnik 1 nie wpywa na zmienn zale偶n.*

-   $0_2$: *Czynnik 2 nie wpywa na zmienn zale偶n.*

-   $0_{1-2}$: *Wzajemna interakcja czynnik贸w 1 i 2 nie wpywa na zmienn zale偶n.*

Analiz Anova i czynnoci przygotowawcze wykonano w R (RStudio). Analiz post-hoc por贸wnania parami - w Pythonie.

# Wczytanie i analiza danych

```{r}
#| label: Wczytywanie_danych

daneA <- read.table("ChodziwoA.txt", header=T)
daneB <- read.table("ChodziwoB.txt", header=T)
```

```{r, echo = F}
#| label: tbl-1
#| tbl-cap: "Pomiary rednicy $d$ dla chodziwa A"
#| message: false
#| warning: false

if (!require(reticulate)) {install.packages('reticulate', 
                        repos="http://cran.us.r-project.org"); 
                        require(reticulate)}
if (!require(magnittr)) {install.packages('magnittr', 
                        repos="http://cran.us.r-project.org"); 
                        require(magnittr)}
if (!require(knitr)) {install.packages('knitr',
                        repos="http://cran.us.r-project.org");
                        require(knitr)}
if (!require(kableExtra)) {install.packages('kableExtra', 
                        repos="http://cran.us.r-project.org"); 
                        require(kableExtra)}

kable(daneA, row.names = TRUE) %>%
  kable_styling(latex_options = "striped")
```

```{r, echo = F}
#| label: tbl-2
#| tbl-cap: "Pomiary rednicy $d$ dla chodziwa B"
#| message: false
#| warning: false

kable(daneB, row.names = TRUE) %>%
  kable_styling(latex_options = "striped")
```

## Przygotowanie danych do analizy wariancji

Zapis danych w postaci 'data frame', kt贸rej pierwsz kolumn s rednice, a wyr贸偶nik maszyny to druga kolumna, trzecia kolumna to rodzaj chodziwa.

```{r}
#| label: Przygotowanie_danych

n <- dim(daneA)[1]       # liczba pomiar贸w, tzw 'powt贸rze' 
m <- dim(daneA)[2]       # liczba maszyn (kolumn )
k <- 2                   # liczba poziom贸w czynnika 1 (rodzaju chodziwa)

nag <- colnames(daneA)   # nag贸wki kolumn
srednice <- data.frame(data = NA, nrow = 2*n*m,ncol =3)  # deklaracja 
for(j in seq(1,m,1)){
    for (i in seq(1,n,1)){
      srednice[i+(j-1)*n,1] <- daneA[i,j]
      srednice[i+(j-1)*n,2] <- nag[j]
      srednice[i+(j-1)*n,3] <- "A"
    }
}

for(j in seq(1,m,1)){
    for (i in seq(1,n,1)){
      srednice[n*m+i+(j-1)*n,1] <- daneB[i,j]
      srednice[n*m+i+(j-1)*n,2] <- nag[j]
      srednice[n*m+i+(j-1)*n,3] <- "B"
    }
}

# zamiana typu kolumn
srednice[,2] <- as.factor(srednice[,2])
srednice[,3] <- as.factor(srednice[,3])

# wprowadzenie nazw kolumn
colnames(srednice)= c("d","Maszyna", "Chodziwo")
head(srednice)
```

## Wykres pudekowy

```{r}
#| label: fig-2
#| fig-cap: "Wykres pudekowy zale偶noci $d$ od numeru maszyny i chodziwa"
#| message: false
#| warning: false

require(ggplot2)
ggplot(srednice, aes(x = Maszyna, y = d,  fill = Chodziwo) ) +
geom_boxplot()
```

# Analiza Anova

Analiz Anova z uwzgldnieniem interakcji pomidzy czynnikami przeprowadzono w R.

```{r}
#| label: Analiza_Anova
 
anowa <- aov(formula = d ~ Maszyna*Chodziwo, data = srednice)
summary(anowa)
```

## Wynik analizy

Anova wykazaa, 偶e czynnikiem wpywajcym na wynik (rednic $d$) w spos贸b istotny statystycznie jest Maszyna. Wynika to z wartoci prawdopodobiestwa p \< 0.05 tylko dla czynnika Maszyna. Rodzaj chodziwa nie ma wpywu (p \>0.05), jak r贸wnie偶 interakcje.

Oznacza to, 偶e przynajmniej jedna z maszyn produkuje elementy r贸偶nice si od innych w spos贸b istotny statystycznie. W celu sprawdzenia, kt贸re maszyny produkuj elementy r贸偶nice si istotnie od innych, nale偶y wykona analiz por贸wnania parami metod Tukeya HSD. Analiza zostaa przeprowadzona z wykorzystaniem Pythona.

# Analiza post-hoc por贸wnania parami

Por贸wnanie parami przeprowadzono metod Tukeya HSD w Pythonie wykorzystujc obiekt R (data frame 'srednice').

```{python}
#| label: Analiza_post-hoc
 

# python -m pip install statsmodels
import pandas as pd
import numpy as np
import statsmodels
from scipy.stats import f_oneway
from statsmodels.stats.multicomp import pairwise_tukeyhsd

# Badanie wpywu czynnika Maszyna
# r.srednice - odwoanie z poziomu Pythona do obiektu R
tuk1 = pairwise_tukeyhsd(endog=r.srednice['d'],
                          groups=r.srednice['Maszyna'],
                          alpha=0.05)
print(tuk1)

# Badanie wpywu czynnika Chodziwo
tuk2 = pairwise_tukeyhsd(endog=r.srednice['d'],
                          groups=r.srednice['Chodziwo'],
                          alpha=0.05)
print(tuk2)
```

# Analiza wpywu maszyny

Wynik por贸wnania dla czynnika Chodziwo oznacza, 偶e nie ma ono istotnego statystycznie wpywu na rednic elemenu (p \> 0.05). Wyniki por贸wnania parami dla czynnika Maszyna przeanalizowano w R, wykorzystujc uzyskany wczeniej obiekt Pythona (pairwise_tukeyhsd).

```{r}
#| label: Analiza_wynikow
#| message: false
#| warning: false

  kombinacja <- function(dane){      
# definicja funkcji wykonujcej kombinacj poziom贸w faktora "dane"
#  i zapisujcej je jako jednokolumnow data frame
  
  elementy <- levels(dane)           # poziomy faktora "dane"
  kombinacje <- combn(elementy,2,paste, collapse = "-", simplify = TRUE)
  kombinacje <- as.data.frame(kombinacje)
  return(kombinacje)
}
# kombinacja(srednice$Maszyna)
```

## Maszyny r贸偶nice si w spos贸b statystycznie istotny

```{r}
#| message: false
#| warning: false

require(reticulate)                             # hub do Pythona

# liczba mo偶liwych kombinacji 2 r贸偶nych liczb spor贸d 5
n <- factorial(5)/factorial(2)/factorial(3)     # factorial() - silnia
kombi <- kombinacja(srednice$Maszyna)           # mo偶liwe kombinacje maszyn

# wyszukiwanie wynik贸w por贸wnania parami z prawdopodobiestwem p < 0.05
wynik <- data.frame(NA) 
pom <- rep(0,n)
p <- rep(0,n)
j <- 0
for (i in 1:n){    
  if ( py$tuk1$pvalues[i] < 0.05 ) {    # odwoanie z poziomu R do obiektu Pythona
       j <- j+1
       pom[j] <- i
       p[j] <- py$tuk1$pvalues[i]     
  }
}

# zapis wynik贸w wyszukiwania
for (i in 1:j){
  wynik[i,1] <- kombi[pom[i],1] 
  wynik[i,2] <- p[i] 
  wynik[i,3] <- "istotna"
}

colnames(wynik) <- c("Por贸wnanie parami", "p", "r贸偶nica")
```

```{r, echo = F}
#| label: tbl-3
#| tbl-cap: "Maszyny r贸偶nice si w spos贸b istotny statystycznie"
#| tbl-pos: H
#| message: false
#| warning: false

kable(wynik, row.names = FALSE, align = "lll") %>%
  kable_styling(latex_options = "striped")
```

## Maszyny nie r贸偶nice si w spos贸b statystycznie istotny

```{r}

# wyszukiwanie wynik贸w por贸wnania parami z prawdopodobiestwem p > 0.05
wynik <- data.frame(NA) 
pom <- rep(0,n)
p <- rep(0,n)
j <- 0
for (i in 1:n){    
  if ( py$tuk1$pvalues[i] > 0.05 ) {    # odwoanie z poziomu R do obiektu Pythona
       j <- j+1
       pom[j] <- i
       p[j] <- py$tuk1$pvalues[i]     
  }
}

# zapis wynik贸w wyszukiwania
for (i in 1:j){
  wynik[i,1] <- kombi[pom[i],1] 
  wynik[i,2] <- p[i] 
  wynik[i,3] <- "nieistotna"
}

colnames(wynik) <- c("Por贸wnanie parami", "p", "r贸偶nica")
```

```{r, echo = F}
#| label: tbl-4
#| tbl-cap: "Maszyny nie r贸偶nice si w spos贸b statystycznie istotny"
#| message: false
#| warning: false

kable(wynik, row.names = FALSE, align = "lll") %>%
  kable_styling(latex_options = "striped")
```

# Podsumowanie

Analiza ANOVA wykazaa, 偶e wpyw rodzaju chodziwa na wynik w postaci rednicy elementu jest nieistotny statystycznie, natomiast wystpuj r贸偶nice statystycznie istotne pomidzy elementami wyprodukowanymi na r贸偶nych maszynach.

Wyniki zaprezentowane w ostatniej tabeli wskazuj, 偶e maszyny mo偶na podzieli na dwie zazbiajce si grupy:

-   Maszyna1 - Maszyna 3 - Maszyna 4

-   Maszyna 2 - Maszyna 3 - Maszyna 5

Elementem wsp贸lnym obu grup jest Maszyna 3. Jej produkty najmniej r贸偶ni si od pozostaych. Jednak wystpujce r贸偶nice pomidzy grupami wymagaj ustalenia ich przyczyny i wyeliminowania.
